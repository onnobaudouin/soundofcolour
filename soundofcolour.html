<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sound Of Colour</title>
    <script language="javascript" type="text/javascript">
        class SoundOfColourServer {
            constructor(url, canvasID) {
                this.url = url;  //e.g. "ws://localhost:8001/"
                this.websocket = null;
                this.auto_reconnect = true;
                this.auto_reconnect_interval_id = null;
                this.openHandler = evt => this.open(evt);
                this.closeHandler = evt => this.close(evt);
                this.messageHandler = evt => this.message(evt);
                this.errorHandler = evt => this.error(evt);


                this.balls = [];
                this.resolution = {width:0, height:0};
                /*@var Canvas */
                this.canvas = document.getElementById(canvasID);
                this.ctx = this.canvas.getContext("2d");
                this.show_ui = false;


                this.frame_grabber_id = null;
                this.is_grabbing_frame = false;

            }

            connect() {
                console.log("Connecting...");
                clearInterval(this.auto_reconnect_interval_id);
                try {
                    this.websocket = new WebSocket(this.url);
                } catch (ex) {
                    console.log(ex+' port probably closed');
                    this.websocket = null;
                    return;
                }
                this.connect_handlers();

            }

            connect_handlers() {
                this.websocket.addEventListener('open', this.openHandler);
                this.websocket.addEventListener('close', this.closeHandler);
                this.websocket.addEventListener('message', this.messageHandler);
                this.websocket.addEventListener('error', this.errorHandler);
            }

            disconnect_handlers() {
                this.websocket.removeEventListener('open', this.openHandler);
                this.websocket.removeEventListener('close', this.closeHandler);
                this.websocket.removeEventListener('message', this.messageHandler);
                this.websocket.removeEventListener('error', this.errorHandler);
            }

            open(event) {
                console.log('connection open');

                this.frame_grabber_id  = setInterval(() => this.check_frame_grabber(), 20);
            }

            check_frame_grabber() {
                if (this.is_connected()) {
                    //console.log('request a frame');
                    if (this.is_grabbing_frame === false) {
                        this.is_grabbing_frame = true;
                        this.send("frame",
                            { 'quality' : 50, 'format': 'png', ratio: 0.25
                              });
                        return;
                    } else {
                        //console.log('Bounced');
                    }
                }
                this.is_grabbing_frame = false;
            }

            //https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent
            close(close_event) {
                console.log('connection closed: ' + close_event.code + ' ' + close_event.reason);
                this.do_auto_reconnect();
            }

            send_raw(message) {
                if (this.websocket !== null) {
                    this.websocket.send(message);
                }
            }

            update_canvas_size(width, height) {
                this.resolution.width = width;
                this.resolution.height = height;
                if (
                    (this.resolution.width !== this.canvas.width) ||
                    (this.resolution.height !== this.canvas.height) ) {
                    this.canvas.width = this.resolution.width;
                    this.canvas.height = this.resolution.height;
                }
            }

            send(type, message) {
                message.type = type;
                this.send_raw(JSON.stringify(message));
            }


            //https://developer.mozilla.org/en-US/docs/Web/API/MessageEvent
            message(message_event) {
                const message = message_event.data;
               // console.log('message: '+ message);
                if (message.indexOf('Welcome') !== -1) {
                    this.update_show_ui();
                } else {
                    const obj = JSON.parse(message);
                    switch (obj.type) {
                        case "balls":
                            this.update_canvas_size(obj.resolution[0], obj.resolution[1]);
                            //wrap balls up in simple object
                             this.balls = obj.balls.map(b => {
                                return {
                                    id:parseInt(b[0]),
                                    colour:b[1],
                                    radius:parseFloat(b[2]),
                                    x:parseInt(b[3]),
                                    y:parseInt(b[4])
                                };
                            });
                            break;
                        case "frame":
                            //console.log("image_received");
                            let src = false;
                            if (obj.image.format === "jpg") {
                                src = 'data:image/jpg;base64,' + obj.image.data;
                            }
                            else if (obj.image.format === "png") {
                                src = 'data:image/png;base64,' + obj.image.data;
                            }
                            if (src !== false) {
                                let img = document.getElementById('test');
                                img.src = src;
                            }
                            this.is_grabbing_frame = false;
                            break;
                        default:
                            console.log('Unknown message type: '+obj.type)
                    }
                    // should be in som performance timer?
                    this.clear();
                    this.draw_balls()
                }
            }

            clear() {
                this.ctx.fillStyle="black";
                //ctx.fillRect(0,0,300,150);
                this.ctx.fillRect( 0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
            }

            draw_disc(x, y, radius, colour) {
                this.ctx.beginPath();
                this.ctx.arc(x, y, radius, 0, 2 * Math.PI, false);
                this.ctx.fillStyle = colour;
                this.ctx.fill();
            }

            draw_balls() {
                this.balls.forEach(ball => {
                   this.draw_disc(ball.x, ball.y, ball.radius, ball.colour)

                });


            }


            error(event) {
                console.log('connection error: ' + event.type);
                this.do_auto_reconnect();
            }

            is_connected() {
                if(this.websocket !== null) {
                    return (this.websocket.readyState === this.websocket.OPEN);
                }
            }

            disconnected() {
                this.disconnect_handlers();
                this.websocket.close();
                this.websocket = null;
            }

            do_auto_reconnect() {
                this.disconnected();


                if (this.auto_reconnect) {
                    console.log('will attempt reconnect in 1 second');
                    this.auto_reconnect_interval_id = setInterval(() => this.connect(), 1000)
                }
            }

            toggle_ui() {
                this.show_ui = !this.show_ui;
                this.update_show_ui();

            }

            update_show_ui() {
                this.send("show_ui", {"value": this.show_ui} );
            }




        }




    </script>

</head>
<body>
    <div>
   <canvas id="frame"></canvas>
        <img id="test">
    </div>
   <button onclick="soc.toggle_ui()">Toggle UI</button>
<script>
    //ws://
    let soc = new SoundOfColourServer("ws://127.0.0.1:8001", 'frame');
    soc.connect();
</script>

</body>
</html>
